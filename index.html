<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Music Sequencer</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Space+Grotesk:wght@400&display=swap"
    rel="stylesheet"
  />
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #000;
      color: #fff;
      font-family: 'Space Grotesk', sans-serif;
      overflow: hidden;
    }

    /* Top settings bar */
    .settings-bar {
      background: #111;
      padding: 1rem 6rem;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1rem;
      align-items: end;
      z-index: 50;
    }

    /* Visualization in the middle */
    .visualization {
      flex: 1;
      background: #0000df;
      position: relative;
      cursor: pointer;
    }

    /* Bottom note rows – auto height */
    .note-container {
      background: #111;
      padding: 2rem 6rem;
    }
    .note-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1rem;
    }
    .delete-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .delete-row {
      color: grey;
      cursor: pointer;
      font-size: 1.2rem;
      user-select: none;
    }
    .delete-row:hover {
      color: white;
    }

    label { display: block; font-size: 0.8rem; margin-bottom: 0.3rem; }
    input, select, button { font-size: 1rem; }
    input, select {
      all: unset;
      width: 100%;
      border-bottom: 1px solid #fff;
      padding: 0.3rem 0;
      color: #fff;
    }
    input.note-name { font-weight: bold; color: #9aff39; }

    .bottom-row {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    .bottom-row button {
      flex: 1;
      border: 0;
      background: #fff;
      color: #000;
      padding: 0.8rem;
      cursor: pointer;
    }
    .bottom-row button.playing { background: #0f0; }

    .progress-bar {
      position: fixed;
      top: 0; left: 0;
      height: 4px;
      background: #0f0;
      width: 0;
      transition: width 0s;
      z-index: 100;
    }
    .note-rect {
      position: absolute;
      cursor: grab;
      transition: background 0.2s ease;
    }
    .note-rect:hover { background: #fff; }
    .note-rect.dragging { cursor: grabbing; }
  </style>
</head>
<body>
  <div id="progress-bar" class="progress-bar"></div>

  <!-- 1) Settings Bar -->
  <div class="settings-bar">
    <div>
      <label for="bpm-input">BPM</label>
      <input type="number" id="bpm-input" value="120" />
    </div>
    <div>
      <label for="length-input">Length (beats)</label>
      <input type="number" id="length-input" value="4" />
    </div>
    <div>
      <label for="hold-input">Hold (ms)</label>
      <input type="number" id="hold-input" value="100" step="10" min="0" />
    </div>
    <div>
      <label for="default-velocity-input">Default Velocity</label>
      <input
        type="number"
        id="default-velocity-input"
        value="75"
        min="0"
        max="127"
        step="1"
      />
    </div>
    <div>
      <label for="midi-output-select">MIDI Output</label>
      <select id="midi-output-select">
        <option value="">(none)</option>
      </select>
    </div>
    <div>
      <label for="midi-channel-select">MIDI Channel</label>
      <select id="midi-channel-select"></select>
    </div>
  </div>

  <!-- 2) Visualization -->
  <div id="visualization" class="visualization"></div>

  <!-- 3) Note Rows -->
  <div class="note-container" id="note-inputs">
    <div class="note-row">
      <div>
        <label>Note</label>
        <input type="text" placeholder="C4" class="note-name" />
      </div>
      <div>
        <label>Delays (%)</label>
        <input
          type="text"
          placeholder="25, 50 or expressions (100/2)"
          class="note-delay"
        />
      </div>
      <div>
        <label>Length (ms)</label>
        <input type="text" placeholder="optional" class="note-length" />
      </div>
      <div>
        <label>Velocity</label>
        <input type="text" placeholder="0–127" class="note-velocity" />
      </div>
      <div class="delete-cell">
        <span
          class="delete-row"
          title="Delete this row? Clicking the x deletes the row and all associated notes."
        >&times;</span>
      </div>
    </div>

    <div class="bottom-row">
      <button onclick="addInput()">Add Note Row</button>
      <button id="play-button">Play</button>
    </div>
  </div>

  <script>
    let midiAccess, output = null, audioCtx;
    let playing = false, loopInterval;
    const ATTACK = 0.01, RELEASE = 0.05;

    const bpmInput             = document.getElementById('bpm-input');
    const lengthInput          = document.getElementById('length-input');
    const holdInput            = document.getElementById('hold-input');
    const defaultVelocityInput = document.getElementById('default-velocity-input');
    const midiOutputSelect     = document.getElementById('midi-output-select');
    const midiChannelSelect    = document.getElementById('midi-channel-select');
    const playButton           = document.getElementById('play-button');
    const visualization        = document.getElementById('visualization');
    const progressBar          = document.getElementById('progress-bar');
    const noteInputs           = document.getElementById('note-inputs');

    navigator.requestMIDIAccess()
      .then(midi => {
        midiAccess = midi;
        midi.outputs.forEach(port => {
          const opt = document.createElement('option');
          opt.value = port.id;
          opt.textContent = port.name;
          midiOutputSelect.append(opt);
        });
        if (midi.outputs.size) {
          const first = [...midi.outputs.values()][0];
          midiOutputSelect.value = first.id;
          output = first;
        }
      })
      .catch(() => { output = null; });

    midiOutputSelect.addEventListener('change', () => {
      output = midiAccess.outputs.get(midiOutputSelect.value) || null;
    });

    for (let i = 0; i < 16; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i + 1;
      midiChannelSelect.append(opt);
    }

    function noteToMidi(n) {
      const m = n.match(/^([A-Ga-g])([#b\u266D]?)(\d)$/);
      if (!m) return null;
      const note   = m[1].toUpperCase();
      const acc    = m[2];
      let octave   = parseInt(m[3], 10);
      const base   = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 }[note];
      let semitone = base
        + (acc === '#' ? 1 : (acc === 'b' || acc === '\u266D') ? -1 : 0);
      if (semitone < 0)     { semitone += 12; octave -= 1; }
      else if (semitone > 11){ semitone -= 12; octave += 1; }
      return (octave + 1) * 12 + semitone;
    }

    function midiNoteToFreq(m) {
      return 440 * Math.pow(2, (m - 69) / 12);
    }

    function evaluate(e) {
      try { return Function('return(' + e + ')')(); }
      catch { return NaN; }
    }
    function parseList(s) {
      return s.split(',')
        .map(x => evaluate(x.trim()))
        .filter(x => !isNaN(x));
    }
    function formatList(a) {
      return a.map(x => x.toFixed(2)).join(',');
    }

    function getLoopDuration() {
      return +lengthInput.value * (60 / +bpmInput.value) * 1000;
    }
    function animateProgressBar() {
      progressBar.style.transition = 'none';
      progressBar.style.width = '0';
      requestAnimationFrame(() => {
        progressBar.style.transition = `width ${getLoopDuration()}ms linear`;
        progressBar.style.width = '100%';
      });
    }

    function addDeleteHandler(div) {
      const btn = div.querySelector('.delete-row');
      btn.addEventListener('click', () => {
        div.remove();
        renderNotes();
      });
    }

    function addInput() {
      // update visualization first to avoid overlap
      renderNotes();

      const div = document.createElement('div');
      div.className = 'note-row';
      div.innerHTML = `
        <div><label>Note</label><input type="text" placeholder="C4" class="note-name"></div>
        <div><label>Delays (%)</label><input type="text" placeholder="25, 50 or expressions (100/2)" class="note-delay"></div>
        <div><label>Length (ms)</label><input type="text" placeholder="optional" class="note-length"></div>
        <div><label>Velocity</label><input type="text" placeholder="0–127" class="note-velocity"></div>
        <div class="delete-cell"><span class="delete-row" title="Delete this row? Clicking the x deletes the row and all associated notes.">&times;</span></div>
      `;
      noteInputs.insertBefore(div, noteInputs.querySelector('.bottom-row'));
      addDeleteHandler(div);
    }

    function playTone(freq, start, dur, vel=100) {
      if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(), g = audioCtx.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(freq, now);
      osc.connect(g); g.connect(audioCtx.destination);
      const volume = Math.max(0,Math.min(1,vel/127));
      g.gain.setValueAtTime(0, now+start);
      g.gain.linearRampToValueAtTime(volume, now+start+ATTACK);
      g.gain.setValueAtTime(volume, now+start+dur);
      g.gain.linearRampToValueAtTime(0, now+start+dur+RELEASE);
      osc.start(now+start);
      osc.stop(now+start+dur+RELEASE);
    }

    function playSequence() {
      const measure    = +lengthInput.value * (60 / +bpmInput.value);
      const defaultVel = Math.round(Math.max(0,Math.min(127,+defaultVelocityInput.value)));
      const channel    = Math.max(0,Math.min(15,+midiChannelSelect.value));
      const noteOnOp   = 0x90|channel, noteOffOp = 0x80|channel;

      document.querySelectorAll('.note-row').forEach(row=>{
        const midi       = noteToMidi(row.querySelector('.note-name').value.trim());
        if (midi==null) return;
        const freq       = midiNoteToFreq(midi);
        const delays     = parseList(row.querySelector('.note-delay').value);
        const lengths    = parseList(row.querySelector('.note-length').value).map(ms=>ms/1000);
        const velocities = parseList(row.querySelector('.note-velocity').value);

        delays.forEach((d,i)=>{
          const delaySec = d/100 * measure;
          let dur = parseFloat(holdInput.value)/1000;
          if (lengths.length===delays.length) dur=lengths[i];
          else if (lengths.length===1)        dur=lengths[0];

          let vel;
          if      (velocities.length===delays.length) vel=velocities[i];
          else if (velocities.length===1)              vel=velocities[0];
          else                                         vel=defaultVel;
          vel = Math.round(Math.max(0,Math.min(127,vel)));

          if (output) {
            setTimeout(()=>{
              output.send([noteOnOp,midi,vel]);
              setTimeout(()=>output.send([noteOffOp,midi,0]),dur*1000);
            },delaySec*1000);
          } else {
            playTone(freq,delaySec,dur,vel);
          }
        });
      });
    }

    function renderNotes() {
      visualization.innerHTML = '';
      const rows=[];

      document.querySelectorAll('.note-row').forEach((row,idx)=>{
        const midi   = noteToMidi(row.querySelector('.note-name').value.trim());
        const delays = parseList(row.querySelector('.note-delay').value);
        if (midi!=null && delays.length) rows.push({row,midi,delays,idx});
      });
      if (!rows.length) return;
      rows.sort((a,b)=>b.midi - a.midi);

      const slotH = visualization.clientHeight/rows.length;
      const defaultVel = Math.round(Math.max(0,Math.min(127,+defaultVelocityInput.value)));

      rows.forEach((rdata,i)=>{
        const velocities = parseList(rdata.row.querySelector('.note-velocity').value);
        rdata.delays.forEach((d,j)=>{
          const x       = d/100 * visualization.clientWidth;
          const lengths = parseList(rdata.row.querySelector('.note-length').value).map(ms=>ms/1000);
          let duration  = parseFloat(holdInput.value)/1000;
          if (lengths.length===rdata.delays.length) duration = lengths[j];
          else if (lengths.length===1)               duration = lengths[0];
          const width   = (duration/(+lengthInput.value*(60/+bpmInput.value)))*visualization.clientWidth;

          // grey → white interpolation
          let vel = (velocities.length===rdata.delays.length) ? velocities[j]
                  : (velocities.length===1)                 ? velocities[0]
                  : defaultVel;
          vel = Math.round(Math.max(0,Math.min(127,vel)));
          const ratio = vel/127;
          const minG  = 128;
          const c     = Math.round(minG + (255 - minG)*ratio);
          const color = `rgb(${c},${c},${c})`;

          const rect = document.createElement('div');
          rect.className = 'note-rect';
          rect.style.left       = `${x}px`;
          rect.style.top        = `${i*slotH}px`;
          rect.style.width      = `${width}px`;
          rect.style.height     = `${slotH}px`;
          rect.style.background = color;
          rect.dataset.rowIndex = rdata.idx;
          rect.dataset.idx      = j;
          rect.addEventListener('pointerdown', startDrag);
          rect.addEventListener('dblclick', e=>{
            e.stopPropagation();
            const inp = rdata.row.querySelector('.note-delay');
            let arr = parseList(inp.value);
            const rm = arr.findIndex(v=>Math.abs(v-d)<0.001);
            if (rm!==-1) {
              arr.splice(rm,1);
              inp.value = formatList(arr);
              renderNotes();
            }
          });
          visualization.appendChild(rect);
        });
      });
    }

    function startDrag(e) {
      e.stopPropagation();
      const r = e.target;
      r.classList.add('dragging');
      const rows = document.querySelectorAll('.note-row');
      const inp  = rows[r.dataset.rowIndex].querySelector('.note-delay');
      const rB   = r.getBoundingClientRect();
      const vB   = visualization.getBoundingClientRect();
      const offsetX = e.clientX - rB.left;

      function move(ev) {
        let x = ev.clientX - vB.left - offsetX;
        x = Math.max(0,Math.min(visualization.clientWidth - rB.width, x));
        r.style.left = x+'px';
      }
      function up() {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        r.classList.remove('dragging');
        let arr = parseList(inp.value);
        arr[r.dataset.idx] = parseFloat(((parseFloat(r.style.left)/visualization.clientWidth)*100).toFixed(2));
        inp.value = formatList(arr);
        renderNotes();
      }

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    }

    visualization.addEventListener('dblclick', e=>{
      const height = visualization.clientHeight;
      let rowsData = [];
      document.querySelectorAll('.note-row').forEach((row,idx)=>{
        const midi   = noteToMidi(row.querySelector('.note-name').value.trim());
        const delays = parseList(row.querySelector('.note-delay').value);
        if (midi!=null && delays.length) rowsData.push({row,midi,idx});
      });
      if (!rowsData.length) return;
      rowsData.sort((a,b)=>b.midi - a.midi);
      const slotH = height/rowsData.length;
      const rowIdx= Math.floor(e.offsetY/slotH);
      if (rowIdx<0||rowIdx>=rowsData.length) return;
      const target = rowsData[rowIdx];
      const pct    = parseFloat(((e.offsetX/visualization.clientWidth)*100).toFixed(2));
      let arr      = parseList(target.row.querySelector('.note-delay').value);
      arr.push(pct);
      target.row.querySelector('.note-delay').value = formatList(arr);
      renderNotes();
    });

    document.getElementById('play-button').addEventListener('click', ()=>{
      playing = !playing;
      playButton.classList.toggle('playing', playing);
      if (playing) {
        playSequence();
        renderNotes();
        animateProgressBar();
        loopInterval = setInterval(()=>{
          playSequence();
          renderNotes();
          animateProgressBar();
        }, getLoopDuration());
      } else {
        clearInterval(loopInterval);
      }
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      // attach delete to initial row
      document.querySelectorAll('.note-row').forEach(addDeleteHandler);
      renderNotes();
    });
  </script>
</body>
</html>
