<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Music Sequencer</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Space+Grotesk:wght@400&display=swap"
    rel="stylesheet"
  />
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #000;
      color: #fff;
      font-family: 'Space Grotesk', sans-serif;
      overflow: hidden;
    }
    .settings-bar {
      position: relative; z-index: 3;
      background: #111;
      padding: 1rem 6rem;
      display: grid;
      /* now 6 equal reduced columns for all inputs/selects, then buttons */
      grid-template-columns: repeat(6, 0.25fr) auto;
      gap: 1rem;
      align-items: end;
    }
    .file-btn {
      all: unset;
      background: #111111;
      color: #757575;
      padding: .3rem .6rem;
      cursor: pointer;
      border: 1px solid #757575;
      text-align: center;
    }
    .file-btn:hover {
      color: #ffffff;
      border-color: #ffffff;
    }
    .visualization {
      position: relative; z-index: 1;
      flex: 1;
      background: #0000df;
      cursor: pointer;
    }
    .note-container {
      position: relative; z-index: 2;
      background: #111;
      padding: 2rem 6rem;
    }
    .note-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1rem;
    }
    .delete-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .delete-row {
      color: #24435f;
      cursor: pointer;
      user-select: none;
      font-size: 1.2rem;
    }
    .delete-row:hover {
      color: #fff;
    }
    label {
      display: block;
      font-size: .8rem;
      margin-bottom: .3rem;
    }
    input, select, button {
      font-size: 1rem;
    }
    input, select {
      all: unset;
      width: 100%;
      border-bottom: 1px solid #fff;
      padding: .3rem 0;
      color: #fff;
    }
    input.note-name {
      font-weight: bold;
      color: #9aff39;
    }
    .bottom-row {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    .bottom-row button {
      flex: 1;
      border: 0;
      background: #fff;
      color: #000;
      padding: .8rem;
      cursor: pointer;
    }
    .bottom-row button.playing {
      background: #0f0;
    }
    .progress-bar {
      position: fixed;
      top: 0; left: 0;
      height: 4px;
      background: #0f0;
      width: 0;
      transition: width 0s;
      z-index: 4;
    }
    .note-rect {
      position: absolute;
      z-index: 0;
      cursor: grab;
      transition: background .2s ease;
    }
    .note-rect:hover {
      background: #fff;
    }
    .note-rect.dragging {
      cursor: grabbing;
    }
    /* About modal */
    #about-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10;
      align-items: center;
      justify-content: center;
    }
    #about-content {
      background: rgb(0 0 255);
      color: #fff;
      padding: 1rem 3rem;
      max-width: 46rem;
      font-family: 'Space Grotesk';
      letter-spacing: 0.1rem;
      /* border-radius: 8px; */
      /* box-shadow: 0 0 10px rgba(0,0,0,0.5); */
      position: relative;
    }
    #about-content h2 {
      margin-top: 0;
      text-decoration: underline;
      text-underline-offset: 0em;
    }
    #about-close {
      position: absolute;
      top: .5rem; right: .5rem;
      cursor: pointer;
      font-size: 1.2rem;
      color: #888;
    }
    #about-close:hover {
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="progress-bar" class="progress-bar"></div>

  <!-- Settings Bar -->
  <div class="settings-bar">
    <div>
      <label for="bpm-input">BPM</label>
      <input id="bpm-input" type="number" value="120" />
    </div>
    <div>
      <label for="length-input">Length (beats)</label>
      <input id="length-input" type="number" value="4" />
    </div>
    <div>
      <label for="hold-input">Default Length (ms)</label>
      <input id="hold-input" type="number" value="100" step="10" min="0" />
    </div>
    <div>
      <label for="default-velocity-input">Default Velocity</label>
      <input id="default-velocity-input" type="number" value="75" min="0" max="127" />
    </div>
    <div>
      <label for="midi-output-select">MIDI Output</label>
      <select id="midi-output-select"><option>(none)</option></select>
    </div>
    <div>
      <label for="midi-channel-select">MIDI Channel</label>
      <select id="midi-channel-select"></select>
    </div>
    <div style="display:flex; gap:.5rem; justify-self:end;">
      <button id="export-button" class="file-btn">Export</button>
      <button id="about-button" class="file-btn">About</button>
    </div>
  </div>

  <!-- Visualization -->
  <div id="visualization" class="visualization"></div>

  <!-- Note Rows -->
  <div class="note-container" id="note-inputs">
    <div class="note-row">
      <div>
        <label>Note</label>
        <input class="note-name" placeholder="C4" />
      </div>
      <div>
        <label>Offset (%)</label>
        <input class="note-delay" placeholder="numbers or expressions" />
      </div>
      <div>
        <label>Length (ms)</label>
        <input class="note-length" placeholder="optional" />
      </div>
      <div>
        <label>Velocity</label>
        <input class="note-velocity" placeholder="0–127" />
      </div>
      <div class="delete-cell">
        <span class="delete-row">&times;</span>
      </div>
    </div>
    <div class="bottom-row">
      <button onclick="addInput()">Add Note Row</button>
      <button id="play-button">Play</button>
    </div>
  </div>

  <!-- About Modal -->
  <div id="about-modal">
    <div id="about-content">
      <span id="about-close">&times;</span>
      <h2>Frisch's Fluid MIDI Sequencer 2.0</h2>
      <p>This MIDI sequencer allows you to break free of the grid.</p>
      <ul>
        <li>Enter notes (e.g. C4, F#3, Bb4) including flats.</li>
        <li>Each note has their own row. New rows can be added and removed. </li>
        <li>Specify when a note is triggered as a percentage of the given loop. You can also enter these percentages via mathematical expressions, i.e. 100/4.</li>
        <li>Each note is assigned the default values for length and velocity.</li>
        <li>This default can be overwritten per note row via the two optional fields. Adding one value sets a new default for all notes in this row. Adding as many values as notes are specified, assigns each note their respective velocity or length value.</li>
        <li>Drag the not visualization to adjust timing.</li>
        <li>Double-click the blue area to add new step points.</li>
        <li>Export your pattern as standard MIDI file.</li>
        <li>If no suitable midi interface is connected, a simple sine synth is activated.</li>
      </ul>
      <p>First conceptualized in 2018; Revisited and revived thanks to the LLMs in 2025.</p>
    </div>
  </div>

  <script>
    // DOM refs & globals
    let midiAccess, output = null, audioCtx;
    let playing = false, loopInterval;
    const ATTACK = .01, RELEASE = .05;
    const bpmInput = document.getElementById('bpm-input'),
          lengthInput = document.getElementById('length-input'),
          holdInput = document.getElementById('hold-input'),
          defaultVelocityInput = document.getElementById('default-velocity-input'),
          midiOutputSelect = document.getElementById('midi-output-select'),
          midiChannelSelect = document.getElementById('midi-channel-select'),
          playButton = document.getElementById('play-button'),
          visualization = document.getElementById('visualization'),
          progressBar = document.getElementById('progress-bar'),
          noteInputs = document.getElementById('note-inputs'),
          exportButton = document.getElementById('export-button'),
          aboutButton = document.getElementById('about-button'),
          aboutModal = document.getElementById('about-modal'),
          aboutClose = document.getElementById('about-close');

    // MIDI setup
    navigator.requestMIDIAccess()
      .then(midi => {
        midiAccess = midi;
        midi.outputs.forEach(port => {
          const o = document.createElement('option');
          o.value = port.id; o.textContent = port.name;
          midiOutputSelect.append(o);
        });
        if (midi.outputs.size) {
          const first = [...midi.outputs.values()][0];
          midiOutputSelect.value = first.id;
          output = first;
        }
      })
      .catch(_ => output = null);

    midiOutputSelect.addEventListener('change', () => {
      output = midiAccess.outputs.get(midiOutputSelect.value) || null;
    });

    // fill channels 1–16
    for (let i = 0; i < 16; i++) {
      const o = document.createElement('option');
      o.value = i; o.textContent = i + 1;
      midiChannelSelect.append(o);
    }

    // utils
    function noteToMidi(n) {
      const m = n.match(/^([A-Ga-g])([#b\u266D]?)(\d)$/);
      if (!m) return null;
      const note = m[1].toUpperCase(), acc = m[2], oct = parseInt(m[3], 10),
            base = {C:0,D:2,E:4,F:5,G:7,A:9,B:11}[note];
      let semi = base + (acc=='#'?1:(acc=='b'||acc=='\u266D'?-1:0)), o = oct;
      if (semi < 0) { semi += 12; o--; }
      if (semi > 11) { semi -= 12; o++; }
      return (o+1)*12 + semi;
    }
    function midiNoteToFreq(m) {
      return 440 * Math.pow(2, (m - 69) / 12);
    }
    function evaluate(e) {
      try { return Function('return(' + e + ')')(); }
      catch { return NaN; }
    }
    function parseList(s) {
      return s.split(',').map(x => evaluate(x.trim())).filter(x => !isNaN(x));
    }
    function formatList(a) {
      return a.map(x => x.toFixed(2)).join(',');
    }
    function getLoopDuration() {
      return +lengthInput.value * (60 / +bpmInput.value) * 1000;
    }
    function animateProgressBar() {
      progressBar.style.transition = 'none';
      progressBar.style.width = '0';
      requestAnimationFrame(() => {
        progressBar.style.transition = `width ${getLoopDuration()}ms linear`;
        progressBar.style.width = '100%';
      });
    }

    function addDeleteHandler(div) {
      div.querySelector('.delete-row').addEventListener('click', () => {
        div.remove();
        renderNotes();
      });
    }

    function addInput() {
      renderNotes();
      const div = document.createElement('div');
      div.className = 'note-row';
      div.innerHTML = `
        <div><label>Note</label><input class="note-name" placeholder="C4"/></div>
        <div><label>Offset (%)</label><input class="note-delay" placeholder="numbers or expressions"/></div>
        <div><label>Length (ms)</label><input class="note-length" placeholder="optional"/></div>
        <div><label>Velocity</label><input class="note-velocity" placeholder="0–127"/></div>
        <div class="delete-cell"><span class="delete-row">&times;</span></div>
      `;
      noteInputs.insertBefore(div, noteInputs.querySelector('.bottom-row'));
      addDeleteHandler(div);
    }

    function playTone(freq, start, dur, vel=100) {
      if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const now = audioCtx.currentTime,
            osc = audioCtx.createOscillator(),
            g = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, now);
      osc.connect(g);
      g.connect(audioCtx.destination);
      const volume = Math.max(0, Math.min(1, vel/127));
      g.gain.setValueAtTime(0, now+start);
      g.gain.linearRampToValueAtTime(volume, now+start+ATTACK);
      g.gain.setValueAtTime(volume, now+start+dur);
      g.gain.linearRampToValueAtTime(0, now+start+dur+RELEASE);
      osc.start(now+start);
      osc.stop(now+start+dur+RELEASE);
    }

    function playSequence() {
      const measure = +lengthInput.value * (60 / +bpmInput.value),
            defaultVel = Math.round(Math.max(0, Math.min(127, +defaultVelocityInput.value))),
            channel = Math.max(0, Math.min(15, +midiChannelSelect.value)),
            noteOn = 0x90 | channel, noteOff = 0x80 | channel;
      document.querySelectorAll('.note-row').forEach(row => {
        const midi = noteToMidi(row.querySelector('.note-name').value.trim());
        if (midi == null) return;
        const freq = midiNoteToFreq(midi),
              delays = parseList(row.querySelector('.note-delay').value),
              lengths = parseList(row.querySelector('.note-length').value).map(ms=>ms/1000),
              velocities = parseList(row.querySelector('.note-velocity').value);
        delays.forEach((d,i) => {
          const delaySec = d/100 * measure;
          let dur = parseFloat(holdInput.value)/1000;
          if (lengths.length===delays.length) dur = lengths[i];
          else if (lengths.length===1) dur = lengths[0];
          let vel = velocities.length===delays.length ? velocities[i]
                  : velocities.length===1 ? velocities[0]
                  : defaultVel;
          vel = Math.round(Math.max(0, Math.min(127, vel)));
          if (output) {
            setTimeout(() => {
              output.send([noteOn, midi, vel]);
              setTimeout(() => output.send([noteOff, midi, 0]), dur*1000);
            }, delaySec*1000);
          } else {
            playTone(freq, delaySec, dur, vel);
          }
        });
      });
    }

    function renderNotes() {
      visualization.innerHTML = '';
      const rows = [];
      document.querySelectorAll('.note-row').forEach((row, idx) => {
        const midi = noteToMidi(row.querySelector('.note-name').value.trim());
        const delays = parseList(row.querySelector('.note-delay').value);
        if (midi != null && delays.length) rows.push({row, midi, delays, idx});
      });
      if (!rows.length) return;
      rows.sort((a,b)=>b.midi - a.midi);
      const slotH = visualization.clientHeight / rows.length,
            defaultVel = Math.round(Math.max(0, Math.min(127, +defaultVelocityInput.value)));
      rows.forEach((rdata, i) => {
        const lengths = parseList(rdata.row.querySelector('.note-length').value).map(ms=>ms/1000),
              velocities = parseList(rdata.row.querySelector('.note-velocity').value);
        rdata.delays.forEach((d, j) => {
          const x = d/100 * visualization.clientWidth,
                dur = (lengths.length===rdata.delays.length ? lengths[j]
                      : lengths.length===1 ? lengths[0]
                      : parseFloat(holdInput.value)/1000),
                width = (dur/(+lengthInput.value*(60/+bpmInput.value))) * visualization.clientWidth;
          let vel = (velocities.length===rdata.delays.length ? velocities[j]
                   : velocities.length===1 ? velocities[0]
                   : defaultVel);
          vel = Math.round(Math.max(0, Math.min(127, vel)));
          const ratio = vel/127, minG = 64,
                c = Math.round(minG + (255-minG)*ratio),
                color = `rgb(${c},${c},${c})`;
          const rect = document.createElement('div');
          rect.className = 'note-rect';
          rect.style.left = `${x}px`;
          rect.style.top = `${i*slotH}px`;
          rect.style.width = `${width}px`;
          rect.style.height = `${slotH}px`;
          rect.style.background = color;
          rect.dataset.rowIndex = rdata.idx;
          rect.dataset.idx = j;
          rect.addEventListener('pointerdown', startDrag);
          rect.addEventListener('dblclick', e => {
            e.stopPropagation();
            const inp = rdata.row.querySelector('.note-delay'),
                  arr = parseList(inp.value),
                  rm = arr.findIndex(v => Math.abs(v - d) < 0.001);
            if (rm !== -1) {
              arr.splice(rm, 1);
              inp.value = formatList(arr);
              renderNotes();
            }
          });
          visualization.appendChild(rect);
        });
      });
    }

    function startDrag(e) {
      e.stopPropagation();
      const r = e.target,
            rows = document.querySelectorAll('.note-row'),
            inp = rows[r.dataset.rowIndex].querySelector('.note-delay'),
            rB = r.getBoundingClientRect(),
            vB = visualization.getBoundingClientRect(),
            offsetX = e.clientX - rB.left;
      function move(ev) {
        let x = ev.clientX - vB.left - offsetX;
        x = Math.max(0, Math.min(visualization.clientWidth - rB.width, x));
        r.style.left = `${x}px`;
      }
      function up() {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        r.classList.remove('dragging');
        const arr = parseList(inp.value);
        arr[r.dataset.idx] = parseFloat(((parseFloat(r.style.left) / visualization.clientWidth) * 100).toFixed(2));
        inp.value = formatList(arr);
        renderNotes();
      }
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    }

    // double-click to add delay point
    visualization.addEventListener('dblclick', e => {
      const rowsData = [];
      document.querySelectorAll('.note-row').forEach((row, idx) => {
        const midi = noteToMidi(row.querySelector('.note-name').value.trim());
        const delays = parseList(row.querySelector('.note-delay').value);
        if (midi != null && delays.length) rowsData.push({row, midi, idx});
      });
      if (!rowsData.length) return;
      rowsData.sort((a,b)=>b.midi - a.midi);
      const slotH = visualization.clientHeight / rowsData.length;
      const rowIdx = Math.floor(e.offsetY / slotH);
      if (rowIdx < 0 || rowIdx >= rowsData.length) return;
      const target = rowsData[rowIdx];
      const pct = parseFloat(((e.offsetX / visualization.clientWidth) * 100).toFixed(2));
      const inp = target.row.querySelector('.note-delay');
      const arr = parseList(inp.value);
      arr.push(pct);
      inp.value = formatList(arr);
      renderNotes();
    });

    // EXPORT MIDI (manual builder)
    function writeUInt32BE(v, buf, off) {
      buf[off]   = (v >>> 24) & 0xFF;
      buf[off+1] = (v >>> 16) & 0xFF;
      buf[off+2] = (v >>> 8) & 0xFF;
      buf[off+3] = v & 0xFF;
    }
    function writeUInt16BE(v, buf, off) {
      buf[off]   = (v >>> 8) & 0xFF;
      buf[off+1] = v & 0xFF;
    }
    function writeVarLen(v) {
      let bytes = [], buffer = v & 0x7F;
      while ((v >>= 7)) {
        buffer <<= 8;
        buffer |= ((v & 0x7F) | 0x80);
      }
      while (true) {
        bytes.push(buffer & 0xFF);
        if (buffer & 0x80) buffer >>= 8;
        else break;
      }
      return bytes;
    }
    function exportSequence() {
      const data = {
        bpm: +bpmInput.value,
        length: +lengthInput.value,
        hold: +holdInput.value,
        defaultVelocity: +defaultVelocityInput.value,
        midiChannel: +midiChannelSelect.value,
        rows: []
      };
      document.querySelectorAll('.note-row').forEach(r => {
        data.rows.push({
          noteName: r.querySelector('.note-name').value.trim(),
          delays:   parseList(r.querySelector('.note-delay').value),
          lengths:  parseList(r.querySelector('.note-length').value),
          velocities: parseList(r.querySelector('.note-velocity').value)
        });
      });

      const PPQ = 480;
      let events = [];

      // embed JSON as meta-event
      const metaText = JSON.stringify(data);
      events.push({
        delta: 0,
        bytes: [0xFF,0x03, metaText.length]
          .concat(Array.from(new TextEncoder().encode(metaText)))
      });
      // tempo
      const usPerBeat = Math.round(60000000 / data.bpm);
      events.push({ delta:0, bytes:[
        0xFF,0x51,0x03,
        (usPerBeat>>>16)&0xFF,
        (usPerBeat>>>8)&0xFF,
        usPerBeat&0xFF
      ]});
      // program change
      events.push({ delta:0, bytes:[0xC0 | data.midiChannel, 0]});

      // note on/off
      data.rows.forEach(r => {
        r.delays.forEach((d,i) => {
          const tickOn = Math.round((d/100 * data.length) * PPQ);
          let durMs = (r.lengths.length === r.delays.length ? r.lengths[i]
                     : r.lengths.length === 1 ? r.lengths[0]
                     : data.hold);
          const tickLen = Math.round((durMs/1000) * (data.bpm/60) * PPQ);
          let vel = (r.velocities.length === r.delays.length ? r.velocities[i]
                  : r.velocities.length === 1 ? r.velocities[0]
                  : data.defaultVelocity);
          const midi = noteToMidi(r.noteName);
          if (midi == null) return;
          events.push({ tick: tickOn,   type:'on',  midi, vel });
          events.push({ tick: tickOn+tickLen, type:'off', midi, vel:0 });
        });
      });

      // flatten
      events = events
        .filter(e => !e.bytes)
        .sort((a,b)=>a.tick - b.tick)
        .map((e,i,arr) => {
          const delta = e.tick - (arr[i-1]?arr[i-1].tick:0),
                status = ((e.type==='on'?0x90:0x80) | data.midiChannel);
          return { delta, bytes:[status, e.midi, e.vel] };
        });
      events.push({ delta:0, bytes:[0xFF,0x2F,0x00] });

      // header
      const header = new Uint8Array(14);
      header.set([0x4D,0x54,0x68,0x64], 0);
      writeUInt32BE(6, header, 4);
      writeUInt16BE(1, header, 8);
      writeUInt16BE(1, header, 10);
      writeUInt16BE(PPQ, header,12);

      // track
      let trackData = [];
      events.forEach(ev => {
        trackData = trackData
          .concat(writeVarLen(ev.delta))
          .concat(ev.bytes);
      });
      const trkHdr = new Uint8Array(8);
      trkHdr.set([0x4D,0x54,0x72,0x6B],0);
      writeUInt32BE(trackData.length, trkHdr,4);

      const file = new Uint8Array(header.length + trkHdr.length + trackData.length);
      file.set(header,0);
      file.set(trkHdr,header.length);
      file.set(trackData,header.length+trkHdr.length);

      const blob = new Blob([file],{type:'audio/midi'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sequence.mid';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    exportButton.addEventListener('click', exportSequence);

    // About modal logic
    aboutButton.addEventListener('click', () => {
      aboutModal.style.display = 'flex';
    });
    aboutClose.addEventListener('click', () => {
      aboutModal.style.display = 'none';
    });
    aboutModal.addEventListener('click', e => {
      if (e.target === aboutModal) aboutModal.style.display = 'none';
    });

    // init & play
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.note-row').forEach(addDeleteHandler);
      renderNotes();
    });
    playButton.addEventListener('click', () => {
      playing = !playing;
      playButton.classList.toggle('playing', playing);
      if (playing) {
        playSequence();
        renderNotes();
        animateProgressBar();
        loopInterval = setInterval(() => {
          playSequence();
          renderNotes();
          animateProgressBar();
        }, getLoopDuration());
      } else {
        clearInterval(loopInterval);
      }
    });
  </script>
</body>
</html>
